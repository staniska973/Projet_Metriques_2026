<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rapport température Paris</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 24px;
      }

      #chart {
        width: 100%;
        height: 520px;
      }

      #status {
        margin-top: 10px;
        color: #444;
      }

      .retour {
        display: inline-block;
        margin-bottom: 12px;
        text-decoration: none;
        background: #6b7280;
        color: white;
        padding: 8px 12px;
        border-radius: 5px;
      }
    </style>
  </head>

  <body>
    <a class="retour" href="/">Retour à l'accueil</a>
    <h1>Températures horaires - Paris</h1>
    <div id="chart"></div>
    <div id="status">Chargement en cours...</div>

    <script>
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(init);

      let cache = null;

      async function init() {
        try {
          const rows = await chargerDonneesParis();
          cache = rows;
          dessinerGraphique(rows);

          window.addEventListener('resize', () => {
            if (cache) {
              dessinerGraphique(cache);
            }
          });
        } catch (erreur) {
          setStatus('Erreur pendant le chargement: ' + (erreur.message || erreur));
        }
      }

      async function chargerDonneesParis() {
        const reponse = await fetch('/api/paris', {
          headers: { Accept: 'application/json' }
        });

        if (!reponse.ok) {
          throw new Error('HTTP ' + reponse.status + ' sur /api/paris');
        }

        const json = await reponse.json();

        const rows = json.map(point => {
          const date = convertirDate(point.datetime);
          const temperature = Number(point.temperature_c);
          return [date, temperature];
        });

        rows.sort((a, b) => a[0] - b[0]);
        return rows;
      }

      function convertirDate(isoLike) {
        const morceaux = isoLike.split('T');
        const datePart = morceaux[0];
        const timePart = morceaux[1];

        const [annee, mois, jour] = datePart.split('-').map(Number);
        const [heure, minute] = timePart.split(':').map(Number);

        return new Date(annee, mois - 1, jour, heure, minute, 0);
      }

      function dessinerGraphique(rows) {
        const data = new google.visualization.DataTable();
        data.addColumn('datetime', 'Date et heure');
        data.addColumn('number', 'Température (°C)');
        data.addRows(rows);

        const options = {
          title: 'Température à Paris (horaire)',
          legend: { position: 'bottom' },
          hAxis: {
            title: 'Date/Heure',
            format: 'dd/MM HH:mm'
          },
          vAxis: {
            title: 'Température (°C)'
          },
          explorer: { actions: ['dragToZoom', 'rightClickToReset'] }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart'));
        chart.draw(data, options);

        setStatus('OK - ' + rows.length + ' points chargés depuis /api/paris');
      }

      function setStatus(message) {
        document.getElementById('status').textContent = message;
      }
    </script>
  </body>
</html>
